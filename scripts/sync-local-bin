#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_DIR="${LOCAL_BIN_DIR:-$HOME/.local/bin}"
MANIFEST="$TARGET_DIR/.zsh-scripts.managed"

mkdir -p "$TARGET_DIR"

declare -A linked=()
while IFS= read -r -d '' candidate; do
  [[ -f "$candidate" ]] || continue
  [[ -x "$candidate" ]] || continue
  name="$(basename "$candidate")"
  ln -sf "$candidate" "$TARGET_DIR/$name"
  linked["$name"]=1
  printf 'linked %s -> %s\n' "$name" "$candidate"
done < <(find "$SCRIPT_DIR" -mindepth 1 -maxdepth 1 -type f -perm -u+x -print0)

if [[ -f "$MANIFEST" ]]; then
  while IFS= read -r previous; do
    [[ -n "$previous" ]] || continue
    if [[ -z ${linked[$previous]:-} ]]; then
      stale="$TARGET_DIR/$previous"
      if [[ -L "$stale" ]]; then
        target="$(readlink "$stale")"
        if [[ "$target" == "$SCRIPT_DIR/$previous" ]]; then
          rm -f "$stale"
          printf 'removed stale link %s\n' "$previous"
        fi
      fi
    fi
  done < "$MANIFEST"
fi

{
  for name in "${!linked[@]}"; do
    printf '%s\n' "$name"
  done
} | sort > "$MANIFEST.tmp"
mv "$MANIFEST.tmp" "$MANIFEST"
